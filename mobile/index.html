<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="initial-scale=1,user-scalable=no, width=device-width, height=device-height, viewport-fit=cover">
     <meta http-equiv="Content-Security-Policy" content="default-src 'self' 'unsafe-inline' 'unsafe-eval' data: blob: gap://ready file://* ws: wss: http: https:; script-src 'self' 'unsafe-inline' 'unsafe-eval' data: blob:; style-src 'self' 'unsafe-inline' data: blob:; img-src 'self' data: blob: http: https:; font-src 'self' data: blob:; connect-src 'self' ws: wss: http: https:; object-src 'none'; base-uri 'self'; form-action 'self';"> 
    <title>Trudesk Mobile</title>
    <link rel="icon" type="image/x-icon" href="/favicon.ico">

    <!-- Override localStorage globally to prevent security errors -->
    <script>
      // Define safari variable early for compatibility
      window.safari = window.safari || {};
      
      // Override global variables that might cause errors
      if (typeof safari === 'undefined') {
        window.safari = {};
      }
      
      // Override localStorage globally to prevent "The operation is insecure" errors
      (function() {
        // Store original localStorage methods safely
        var originalLocalStorage = {};
        try {
          originalLocalStorage = {
            getItem: localStorage.getItem.bind(localStorage),
            setItem: localStorage.setItem.bind(localStorage),
            removeItem: localStorage.removeItem.bind(localStorage),
            clear: localStorage.clear.bind(localStorage)
          };
        } catch (e) {
          // If localStorage is not available, create dummy methods
          originalLocalStorage = {
            getItem: function() { return null; },
            setItem: function() { return false; },
            removeItem: function() { return false; },
            clear: function() { return false; }
          };
        }

        // Create safe wrapper
        var safeLocalStorage = {
          getItem: function(key) {
            try {
              return originalLocalStorage.getItem(key);
            } catch (e) {
              console.warn('localStorage get error:', e.message);
              return null;
            }
          },
          setItem: function(key, value) {
            try {
              originalLocalStorage.setItem(key, value);
              return true;
            } catch (e) {
              console.warn('localStorage set error:', e.message);
              return false;
            }
          },
          removeItem: function(key) {
            try {
              originalLocalStorage.removeItem(key);
              return true;
            } catch (e) {
              console.warn('localStorage remove error:', e.message);
              return false;
            }
          },
          clear: function() {
            try {
              originalLocalStorage.clear();
              return true;
            } catch (e) {
              console.warn('localStorage clear error:', e.message);
              return false;
            }
          }
        };

        // Override localStorage methods
        try {
          Object.defineProperty(window, 'localStorage', {
            value: safeLocalStorage,
            writable: false,
            configurable: false
          });
        } catch (e) {
          // Fallback for browsers that don't support Object.defineProperty
          window.localStorage = safeLocalStorage;
        }

        // Also override sessionStorage
        var originalSessionStorage = {};
        try {
          originalSessionStorage = {
            getItem: sessionStorage.getItem.bind(sessionStorage),
            setItem: sessionStorage.setItem.bind(sessionStorage),
            removeItem: sessionStorage.removeItem.bind(sessionStorage),
            clear: sessionStorage.clear.bind(sessionStorage)
          };
        } catch (e) {
          // If sessionStorage is not available, create dummy methods
          originalSessionStorage = {
            getItem: function() { return null; },
            setItem: function() { return false; },
            removeItem: function() { return false; },
            clear: function() { return false; }
          };
        }

        var safeSessionStorage = {
          getItem: function(key) {
            try {
              return originalSessionStorage.getItem(key);
            } catch (e) {
              console.warn('sessionStorage get error:', e.message);
              return null;
            }
          },
          setItem: function(key, value) {
            try {
              originalSessionStorage.setItem(key, value);
              return true;
            } catch (e) {
              console.warn('sessionStorage set error:', e.message);
              return false;
            }
          },
          removeItem: function(key) {
            try {
              originalSessionStorage.removeItem(key);
              return true;
            } catch (e) {
              console.warn('sessionStorage remove error:', e.message);
              return false;
            }
          },
          clear: function() {
            try {
              originalSessionStorage.clear();
              return true;
            } catch (e) {
              console.warn('sessionStorage clear error:', e.message);
              return false;
            }
          }
        };

        try {
          Object.defineProperty(window, 'sessionStorage', {
            value: safeSessionStorage,
            writable: false,
            configurable: false
          });
        } catch (e) {
          // Fallback for browsers that don't support Object.defineProperty
          window.sessionStorage = safeSessionStorage;
        }

        // Override any remaining storage access that might cause issues
        try {
          // Override any direct storage access
          if (window.localStorage) {
            window.localStorage = safeLocalStorage;
          }
          if (window.sessionStorage) {
            window.sessionStorage = safeSessionStorage;
          }
        } catch (e) {
          console.warn('Could not override storage:', e.message);
        }
        
        console.log('localStorage and sessionStorage overridden with safe implementation');
      })();
    </script>

    <!-- compiled css output -->
    <link href="css/ionic.app.css" rel="stylesheet">
    
    <!-- Fonts are loaded via CSS, no need to preload -->
    
    <!-- Prevent layout shift by hiding content until loaded -->
    <style>
      body { visibility: hidden; }
      body.loaded { visibility: visible; }
    </style>

    <!-- ionic/angularjs js -->
    <script src="lib/ionic/js/ionic.bundle.js"></script>

    <script src="lib/ngCordova/dist/ng-cordova.min.js"></script>

    <script src="lib/ngstorage/ngStorage.min.js"></script>

    <!-- cordova script (this will be a 404 during development) -->
    <!-- <script src="cordova.js"></script> -->

    <!--ionic filter plugin-->
    <link rel="stylesheet" href="lib/ionic-filter-bar/dist/ionic.filter.bar.css">
    <script src="lib/ionic-filter-bar/dist/ionic.filter.bar.js" charset="utf-8"></script>

    <!-- Libs -->
    <script src="lib/socket.io-client/dist/socket.io.min.js" charset="utf-8"></script>
    <script src="lib/jquery/dist/jquery.min.js" charset="utf-8"></script>
    <script src="lib/underscore/underscore-min.js" charset="utf-8"></script>
    <script src="lib/d3/d3.min.js" charset="utf-8"></script>
    <script src="lib/c3/c3.min.js"></script>
    <link rel="stylesheet" href="lib/c3/c3.min.css">
    <script src="lib/peity/jquery.peity.min.js"></script>
    <link rel="stylesheet" href="lib/snackbar/dist/snackbar.css">
    <script src="lib/snackbar/dist/snackbar.js" charset="utf-8"></script>
    <script src="lib/ng-cropper/dist/ngCropper.all.js" charset="utf-8"></script>
    <link rel="stylesheet" href="lib/ng-cropper/dist/ngCropper.all.css">
    <!-- <script src="lib/cropperjs/dist/cropper.min.js"></script> -->
    <!-- <link rel="stylesheet" href="lib/cropperjs/dist/cropper.min.css" /> -->
    <script src="lib/angular-elastic/elastic.js" charset="utf-8"></script>
    <script src="lib/Autolinker.js/dist/Autolinker.min.js" charset="utf-8"></script>
    <script src="lib/moment/min/moment.min.js" charset="utf-8"></script>
    <script src="lib/angular-moment/angular-moment.min.js" charset="utf-8"></script>
    <script src="lib/angular-img-http-src/index.js" charset="utf-8"></script>

    <!-- Safe localStorage service override -->
    <script>
      // Override ngStorage module to make it safer
      angular.module('ngStorage').provider('$localStorage', function() {
        var storageKeyPrefix = 'ngStorage-';
        
        this.setKeyPrefix = function (prefix) {
          if (typeof prefix !== 'string') {
            throw new TypeError('[ngStorage] - Provider.setKeyPrefix() expects a String.');
          }
          storageKeyPrefix = prefix;
        };

        var serializer = angular.toJson;
        var deserializer = angular.fromJson;

        this.setSerializer = function (s) {
          if (typeof s !== 'function') {
            throw new TypeError('[ngStorage] - Provider.setSerializer expects a function.');
          }
          serializer = s;
        };

        this.setDeserializer = function (d) {
          if (typeof d !== 'function') {
            throw new TypeError('[ngStorage] - Provider.setDeserializer expects a function.');
          }
          deserializer = d;
        };

        this.get = function (key) {
          try {
            return deserializer(localStorage.getItem(storageKeyPrefix + key));
          } catch (e) {
            console.warn('localStorage get error:', e.message);
            return null;
          }
        };

        this.set = function (key, value) {
          try {
            return localStorage.setItem(storageKeyPrefix + key, serializer(value));
          } catch (e) {
            console.warn('localStorage set error:', e.message);
            return false;
          }
        };

        this.$get = ['$rootScope', '$window', function($rootScope, $window) {
          var $storage = {};
          var webStorage = $window.localStorage;
          var supported = true;

          // Check if localStorage is available
          try {
            if (!webStorage || typeof webStorage.setItem !== 'function' || typeof webStorage.getItem !== 'function') {
              supported = false;
            }
            // Test write/read
            var testKey = '__test__';
            webStorage.setItem(testKey, 'test');
            webStorage.removeItem(testKey);
          } catch (e) {
            supported = false;
          }

          function safeDecode(value) {
            try {
              return angular.fromJson(value);
            } catch (e) {
              return value;
            }
          }

          function safeEncode(value) {
            try {
              return angular.toJson(value);
            } catch (e) {
              return String(value);
            }
          }

          if (supported) {
            for (var key in webStorage) {
              if (webStorage.hasOwnProperty(key) && storageKeyPrefix === key.slice(0, storageKeyPrefix.length)) {
                try {
                  $storage[key.slice(storageKeyPrefix.length)] = safeDecode(webStorage.getItem(key));
                } catch (e) {
                  console.warn('Error loading storage key:', key, e.message);
                }
              }
            }
          }

          $storage.$default = function(items) {
            for (var k in items) {
              if (angular.isDefined(items[k]) && angular.isUndefined($storage[k])) {
                $storage[k] = angular.copy(items[k]);
              }
            }
            return $storage;
          };

          $storage.$reset = function(items) {
            for (var k in $storage) {
              if (k[0] !== '$') {
                delete $storage[k];
              }
            }
            return $storage.$default(items);
          };

          $storage.$sync = function () {
            if (!supported) return;
            
            for (var key in $storage) {
              if (key[0] === '$') continue;
              
              try {
                if (angular.isUndefined($storage[key])) {
                  webStorage.removeItem(storageKeyPrefix + key);
                } else {
                  webStorage.setItem(storageKeyPrefix + key, safeEncode($storage[key]));
                }
              } catch (e) {
                console.warn('Error syncing storage key:', key, e.message);
              }
            }
          };

          $storage.$apply = function() {
            var temp$storage;

            if (!supported) return;
            
            _watchTimeoutId = null;

            try {
              if ((temp$storage = webStorage.getItem(storageKeyPrefix))) {
                temp$storage = safeDecode(temp$storage);

                for (var key in temp$storage) {
                  if (angular.isDefined(temp$storage[key]) && $storage[key] !== temp$storage[key]) {
                    $storage[key] = temp$storage[key];
                  }
                }
              }
            } catch (e) {
              console.warn('Error applying storage changes:', e.message);
            }
          };

          var _watchTimeoutId;

          function _watchStorage() {
            if (!supported) return;
            
            var temp$storage;
            try {
              if ((temp$storage = webStorage.getItem(storageKeyPrefix))) {
                temp$storage = safeDecode(temp$storage);
                for (var key in temp$storage) {
                  if (angular.isDefined(temp$storage[key]) && $storage[key] !== temp$storage[key]) {
                    $storage[key] = temp$storage[key];
                    $rootScope.$broadcast('ngStorage-changed', key);
                  }
                }
              }
            } catch (e) {
              console.warn('Error watching storage:', e.message);
            }
            _watchTimeoutId = setTimeout(_watchStorage, 100);
          }

          _watchStorage();

          $rootScope.$watch(function() {
            _watchTimeoutId || (_watchTimeoutId = setTimeout(function() {
              if (angular.isObject($storage)) {
                try {
                  if (supported) {
                    webStorage.setItem(storageKeyPrefix, safeEncode($storage));
                    $storage.$sync();
                  }
                } catch (e) {
                  console.warn('Error updating storage:', e.message);
                }
              }
              _watchTimeoutId = null;
            }, 100));
          });

          // If the browser doesn't support localStorage, use memory storage
          if (!supported) {
            console.warn('localStorage not supported, using memory storage');
          }

          return $storage;
        }];
      });
    </script>

    <!-- your app's js -->
    <script src="js/dist/td.app.min.js"></script>
    
    <!-- Show content after everything is loaded -->
    <script>
      // Global error handler to catch any remaining errors
      window.addEventListener('error', function(e) {
        console.warn('Caught error:', e.message, e.filename, e.lineno);
        // Don't prevent default to avoid breaking the app
      });
      
      // Handle unhandled promise rejections
      window.addEventListener('unhandledrejection', function(e) {
        console.warn('Unhandled promise rejection:', e.reason);
        e.preventDefault(); // Prevent the error from showing in console
      });
      
      window.addEventListener('load', function() {
        document.body.classList.add('loaded');
      });
    </script>
  </head>
  <body ng-app="trudesk">
    <div class="mobile-container">
    <div id="loader"></div>
      <ion-nav-bar class="bar-dark nav-title-slide-ios7">
        <ion-nav-back-button>
        </ion-nav-back-button>
      </ion-nav-bar>

      <ion-nav-view></ion-nav-view>
    </div>
  </body>
</html>
