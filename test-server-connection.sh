#!/bin/bash

# –¢–µ—Å—Ç–æ–≤—ã–π —Å–∫—Ä–∏–ø—Ç –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è –∫ —Å–µ—Ä–≤–µ—Ä—É
# –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ: ./test-server-connection.sh [server_user@server_ip]

set -e

# –¶–≤–µ—Ç–∞ –¥–ª—è –≤—ã–≤–æ–¥–∞
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
NC='\033[0m' # No Color

# –ü–∞—Ä–∞–º–µ—Ç—Ä—ã
SERVER=${1:-"user@your-server.com"}
DEPLOY_PATH="/opt/herzen/core"

echo -e "${GREEN}üîç –¢–µ—Å—Ç–∏—Ä—É–µ–º –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –∫ —Å–µ—Ä–≤–µ—Ä—É${NC}"
echo -e "${YELLOW}–°–µ—Ä–≤–µ—Ä: $SERVER${NC}"
echo -e "${YELLOW}–ü—É—Ç—å —Ä–∞–∑–≤–µ—Ä—Ç—ã–≤–∞–Ω–∏—è: $DEPLOY_PATH${NC}"

# –ü—Ä–æ–≤–µ—Ä—è–µ–º –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –∫ —Å–µ—Ä–≤–µ—Ä—É
echo -e "${YELLOW}üì° –ü—Ä–æ–≤–µ—Ä—è–µ–º –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –∫ —Å–µ—Ä–≤–µ—Ä—É...${NC}"
if ! ssh -o ConnectTimeout=10 $SERVER "echo '–ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ —É—Å–ø–µ—à–Ω–æ'"; then
  echo -e "${RED}‚ùå –ù–µ —É–¥–∞–µ—Ç—Å—è –ø–æ–¥–∫–ª—é—á–∏—Ç—å—Å—è –∫ —Å–µ—Ä–≤–µ—Ä—É${NC}"
  exit 1
fi

# –ü—Ä–æ–≤–µ—Ä—è–µ–º SSH –∫–ª—é—á
echo -e "${YELLOW}üîë –ü—Ä–æ–≤–µ—Ä—è–µ–º SSH –∫–ª—é—á...${NC}"
if ! ssh -o BatchMode=yes -o ConnectTimeout=10 $SERVER "echo 'SSH –∫–ª—é—á —Ä–∞–±–æ—Ç–∞–µ—Ç'" 2>/dev/null; then
  echo -e "${RED}‚ùå SSH –∫–ª—é—á –Ω–µ –Ω–∞—Å—Ç—Ä–æ–µ–Ω –∏–ª–∏ –Ω–µ —Ä–∞–±–æ—Ç–∞–µ—Ç –±–µ–∑ –ø–∞—Ä–æ–ª—è${NC}"
  exit 1
fi
echo -e "${GREEN}‚úÖ SSH –∫–ª—é—á —Ä–∞–±–æ—Ç–∞–µ—Ç –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ${NC}"

# –ü—Ä–æ–≤–µ—Ä—è–µ–º —Å–∏—Å—Ç–µ–º–Ω—É—é –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é
echo -e "${YELLOW}üíª –°–∏—Å—Ç–µ–º–Ω–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è:${NC}"
ssh $SERVER "
  echo 'OS: \$(lsb_release -d | cut -f2)'
  echo 'Kernel: \$(uname -r)'
  echo 'User: \$(whoami)'
  echo 'Home: \$HOME'
  echo 'PWD: \$(pwd)'
"

# –ü—Ä–æ–≤–µ—Ä—è–µ–º —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–Ω—ã–µ –ø–∞–∫–µ—Ç—ã
echo -e "${YELLOW}üì¶ –ü—Ä–æ–≤–µ—Ä—è–µ–º —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–Ω—ã–µ –ø–∞–∫–µ—Ç—ã:${NC}"
ssh $SERVER "
  echo 'Git: \$(git --version 2>/dev/null || echo \"–Ω–µ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω\")'
  echo 'Docker: \$(docker --version 2>/dev/null || echo \"–Ω–µ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω\")'
  echo 'Curl: \$(curl --version 2>/dev/null | head -1 || echo \"–Ω–µ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω\")'
"

# –ü—Ä–æ–≤–µ—Ä—è–µ–º –ø—Ä–∞–≤–∞ –¥–æ—Å—Ç—É–ø–∞ –∫ —Ü–µ–ª–µ–≤–æ–π –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏–∏
echo -e "${YELLOW}üìÅ –ü—Ä–æ–≤–µ—Ä—è–µ–º –ø—Ä–∞–≤–∞ –¥–æ—Å—Ç—É–ø–∞ –∫ $DEPLOY_PATH:${NC}"
ssh $SERVER "
  if [ -d \"$DEPLOY_PATH\" ]; then
    echo '–î–∏—Ä–µ–∫—Ç–æ—Ä–∏—è —Å—É—â–µ—Å—Ç–≤—É–µ—Ç'
    ls -la $DEPLOY_PATH
  else
    echo '–î–∏—Ä–µ–∫—Ç–æ—Ä–∏—è –Ω–µ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç'
    echo '–ü—Ä–æ–≤–µ—Ä—è–µ–º —Ä–æ–¥–∏—Ç–µ–ª—å—Å–∫—É—é –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏—é:'
    ls -la \$(dirname $DEPLOY_PATH) 2>/dev/null || echo '–†–æ–¥–∏—Ç–µ–ª—å—Å–∫–∞—è –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏—è –Ω–µ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç'
  fi
"

# –ü—Ä–æ–≤–µ—Ä—è–µ–º –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –∫ GitHub
echo -e "${YELLOW}üåê –ü—Ä–æ–≤–µ—Ä—è–µ–º –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –∫ GitHub:${NC}"
ssh $SERVER "
  if curl -s --connect-timeout 10 https://github.com > /dev/null; then
    echo '‚úÖ –ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –∫ GitHub —Ä–∞–±–æ—Ç–∞–µ—Ç'
  else
    echo '‚ùå –ù–µ—Ç –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è –∫ GitHub'
  fi
"

# –¢–µ—Å—Ç–∏—Ä—É–µ–º –∫–ª–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ –≤ –≤—Ä–µ–º–µ–Ω–Ω—É—é –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏—é
echo -e "${YELLOW}üß™ –¢–µ—Å—Ç–∏—Ä—É–µ–º –∫–ª–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ –≤ –≤—Ä–µ–º–µ–Ω–Ω—É—é –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏—é:${NC}"
ssh $SERVER "
  TEMP_DIR=\"/tmp/test-git-clone-\$(date +%s)\"
  echo '–ö–ª–æ–Ω–∏—Ä—É–µ–º –≤: \$TEMP_DIR'
  
  if git clone https://github.com/durygus/prodesk.git \$TEMP_DIR; then
    echo '‚úÖ –ö–ª–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ —É—Å–ø–µ—à–Ω–æ'
    echo '–°–æ–¥–µ—Ä–∂–∏–º–æ–µ:'
    ls -la \$TEMP_DIR | head -10
    rm -rf \$TEMP_DIR
  else
    echo '‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ –∫–ª–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏–∏'
  fi
"

echo -e "${GREEN}‚úÖ –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –∑–∞–≤–µ—Ä—à–µ–Ω–æ${NC}"
