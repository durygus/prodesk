#!/bin/bash

# Ð¡ÐºÑ€Ð¸Ð¿Ñ‚ Ñ€Ð°Ð·Ð²ÐµÑ€Ñ‚Ñ‹Ð²Ð°Ð½Ð¸Ñ Herzen (Trudesk) Ð½Ð° ÑƒÐ´Ð°Ð»ÐµÐ½Ð½Ð¾Ð¼ ÑÐµÑ€Ð²ÐµÑ€Ðµ
# Ð˜ÑÐ¿Ð¾Ð»ÑŒÐ·Ð¾Ð²Ð°Ð½Ð¸Ðµ: ./deploy.sh [server_user@server_ip] [deploy_path]

set -e

# Ð¦Ð²ÐµÑ‚Ð° Ð´Ð»Ñ Ð²Ñ‹Ð²Ð¾Ð´Ð°
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
NC='\033[0m' # No Color

# ÐŸÐ°Ñ€Ð°Ð¼ÐµÑ‚Ñ€Ñ‹
SERVER=${1:-"user@your-server.com"}
DEPLOY_PATH=${2:-"/opt/herzen"}
APP_NAME="herzen"

echo -e "${GREEN}ðŸš€ ÐÐ°Ñ‡Ð¸Ð½Ð°ÐµÐ¼ Ñ€Ð°Ð·Ð²ÐµÑ€Ñ‚Ñ‹Ð²Ð°Ð½Ð¸Ðµ Herzen Ð½Ð° ÑÐµÑ€Ð²ÐµÑ€Ðµ${NC}"
echo -e "${YELLOW}Ð¡ÐµÑ€Ð²ÐµÑ€: $SERVER${NC}"
echo -e "${YELLOW}ÐŸÑƒÑ‚ÑŒ Ñ€Ð°Ð·Ð²ÐµÑ€Ñ‚Ñ‹Ð²Ð°Ð½Ð¸Ñ: $DEPLOY_PATH${NC}"

# ÐŸÑ€Ð¾Ð²ÐµÑ€ÑÐµÐ¼ Ð¿Ð¾Ð´ÐºÐ»ÑŽÑ‡ÐµÐ½Ð¸Ðµ Ðº ÑÐµÑ€Ð²ÐµÑ€Ñƒ
echo -e "${YELLOW}ðŸ“¡ ÐŸÑ€Ð¾Ð²ÐµÑ€ÑÐµÐ¼ Ð¿Ð¾Ð´ÐºÐ»ÑŽÑ‡ÐµÐ½Ð¸Ðµ Ðº ÑÐµÑ€Ð²ÐµÑ€Ñƒ...${NC}"
ssh -o ConnectTimeout=10 $SERVER "echo 'ÐŸÐ¾Ð´ÐºÐ»ÑŽÑ‡ÐµÐ½Ð¸Ðµ ÑƒÑÐ¿ÐµÑˆÐ½Ð¾'"

# Ð¡Ð¾Ð·Ð´Ð°ÐµÐ¼ Ð´Ð¸Ñ€ÐµÐºÑ‚Ð¾Ñ€Ð¸ÑŽ Ð½Ð° ÑÐµÑ€Ð²ÐµÑ€Ðµ
echo -e "${YELLOW}ðŸ“ Ð¡Ð¾Ð·Ð´Ð°ÐµÐ¼ Ð´Ð¸Ñ€ÐµÐºÑ‚Ð¾Ñ€Ð¸ÑŽ Ð½Ð° ÑÐµÑ€Ð²ÐµÑ€Ðµ...${NC}"
ssh $SERVER "sudo mkdir -p $DEPLOY_PATH && sudo chown \$(whoami):\$(whoami) $DEPLOY_PATH"

# ÐšÐ¾Ð¿Ð¸Ñ€ÑƒÐµÐ¼ Ñ„Ð°Ð¹Ð»Ñ‹ Ð¿Ñ€Ð¾ÐµÐºÑ‚Ð°
echo -e "${YELLOW}ðŸ“¦ ÐšÐ¾Ð¿Ð¸Ñ€ÑƒÐµÐ¼ Ñ„Ð°Ð¹Ð»Ñ‹ Ð¿Ñ€Ð¾ÐµÐºÑ‚Ð°...${NC}"
rsync -avz --exclude 'node_modules' --exclude '.git' --exclude 'data' --exclude 'logs' ./ $SERVER:$DEPLOY_PATH/

# Ð£ÑÑ‚Ð°Ð½Ð°Ð²Ð»Ð¸Ð²Ð°ÐµÐ¼ Ð·Ð°Ð²Ð¸ÑÐ¸Ð¼Ð¾ÑÑ‚Ð¸ Ð½Ð° ÑÐµÑ€Ð²ÐµÑ€Ðµ
echo -e "${YELLOW}ðŸ“¦ Ð£ÑÑ‚Ð°Ð½Ð°Ð²Ð»Ð¸Ð²Ð°ÐµÐ¼ Ð·Ð°Ð²Ð¸ÑÐ¸Ð¼Ð¾ÑÑ‚Ð¸...${NC}"
ssh $SERVER "cd $DEPLOY_PATH && npm install --production"

# Ð¡Ð¾Ð·Ð´Ð°ÐµÐ¼ ÐºÐ¾Ð½Ñ„Ð¸Ð³ÑƒÑ€Ð°Ñ†Ð¸Ð¾Ð½Ð½Ñ‹Ð¹ Ñ„Ð°Ð¹Ð»
echo -e "${YELLOW}âš™ï¸ Ð¡Ð¾Ð·Ð´Ð°ÐµÐ¼ ÐºÐ¾Ð½Ñ„Ð¸Ð³ÑƒÑ€Ð°Ñ†Ð¸Ð¾Ð½Ð½Ñ‹Ð¹ Ñ„Ð°Ð¹Ð»...${NC}"
ssh $SERVER "cd $DEPLOY_PATH && cat > config.yml << 'EOF'
# Herzen Configuration
# Database
mongo:
  uri: mongodb://mongo:27017/herzen

# Server
server:
  port: 8118
  host: 0.0.0.0

# Session
session:
  secret: $(openssl rand -base64 32)

# Email (Ð½Ð°ÑÑ‚Ñ€Ð¾Ð¹Ñ‚Ðµ Ð¿Ð¾Ð´ Ð²Ð°ÑˆÐ¸ Ð½ÑƒÐ¶Ð´Ñ‹)
email:
  enabled: false
  host: smtp.gmail.com
  port: 587
  secure: false
  user: your-email@gmail.com
  pass: your-password

# Redis (Ð¾Ð¿Ñ†Ð¸Ð¾Ð½Ð°Ð»ÑŒÐ½Ð¾)
redis:
  enabled: false
  host: localhost
  port: 6379

# Logging
logging:
  level: info
  file: logs/herzen.log
EOF"

# Ð¡Ð¾Ð·Ð´Ð°ÐµÐ¼ systemd ÑÐµÑ€Ð²Ð¸Ñ
echo -e "${YELLOW}ðŸ”§ Ð¡Ð¾Ð·Ð´Ð°ÐµÐ¼ systemd ÑÐµÑ€Ð²Ð¸Ñ...${NC}"
ssh $SERVER "sudo tee /etc/systemd/system/herzen.service > /dev/null << 'EOF'
[Unit]
Description=Herzen Ticket Management System
After=network.target mongodb.service

[Service]
Type=simple
User=\$(whoami)
WorkingDirectory=$DEPLOY_PATH
ExecStart=/usr/bin/node $DEPLOY_PATH/app.js
Restart=always
RestartSec=10
Environment=NODE_ENV=production
Environment=PORT=8118

[Install]
WantedBy=multi-user.target
EOF"

# ÐŸÐµÑ€ÐµÐ·Ð°Ð³Ñ€ÑƒÐ¶Ð°ÐµÐ¼ systemd
ssh $SERVER "sudo systemctl daemon-reload"

echo -e "${GREEN}âœ… Ð Ð°Ð·Ð²ÐµÑ€Ñ‚Ñ‹Ð²Ð°Ð½Ð¸Ðµ Ð·Ð°Ð²ÐµÑ€ÑˆÐµÐ½Ð¾!${NC}"
echo -e "${YELLOW}ðŸ“‹ Ð¡Ð»ÐµÐ´ÑƒÑŽÑ‰Ð¸Ðµ ÑˆÐ°Ð³Ð¸:${NC}"
echo "1. Ð£ÑÑ‚Ð°Ð½Ð¾Ð²Ð¸Ñ‚Ðµ MongoDB Ð½Ð° ÑÐµÑ€Ð²ÐµÑ€Ðµ:"
echo "   sudo apt update && sudo apt install mongodb"
echo ""
echo "2. ÐÐ°ÑÑ‚Ñ€Ð¾Ð¹Ñ‚Ðµ ÐºÐ¾Ð½Ñ„Ð¸Ð³ÑƒÑ€Ð°Ñ†Ð¸ÑŽ Ð² $DEPLOY_PATH/config.yml"
echo ""
echo "3. Ð—Ð°Ð¿ÑƒÑÑ‚Ð¸Ñ‚Ðµ ÑÐµÑ€Ð²Ð¸Ñ:"
echo "   sudo systemctl start herzen"
echo "   sudo systemctl enable herzen"
echo ""
echo "4. ÐŸÑ€Ð¾Ð²ÐµÑ€ÑŒÑ‚Ðµ ÑÑ‚Ð°Ñ‚ÑƒÑ:"
echo "   sudo systemctl status herzen"
echo ""
echo "5. ÐžÑ‚ÐºÑ€Ð¾Ð¹Ñ‚Ðµ Ð² Ð±Ñ€Ð°ÑƒÐ·ÐµÑ€Ðµ: http://your-server-ip:8118"
